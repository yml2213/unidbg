package com.kuaishou.nebula;

import com.github.unidbg.AndroidEmulator;
import com.github.unidbg.Emulator;
import com.github.unidbg.Module;
import com.github.unidbg.arm.backend.Backend;
import com.github.unidbg.arm.backend.CodeHook;
import com.github.unidbg.arm.backend.UnHook;
import com.github.unidbg.arm.backend.Unicorn2Factory;
import com.github.unidbg.debugger.Debugger;
import com.github.unidbg.debugger.FunctionCallListener;
import com.github.unidbg.file.FileResult;
import com.github.unidbg.file.IOResolver;
import com.github.unidbg.linux.android.AndroidEmulatorBuilder;
import com.github.unidbg.linux.android.AndroidResolver;
import com.github.unidbg.linux.file.ByteArrayFileIO;
import com.github.unidbg.pointer.UnidbgPointer;
import unicorn.UnicornConst;
import unicorn.Arm64Const;
import com.github.unidbg.linux.android.dvm.*;
import com.github.unidbg.linux.android.dvm.api.AssetManager;
import com.github.unidbg.linux.android.dvm.api.PackageInfo;
import com.github.unidbg.linux.android.dvm.api.Signature;
import com.github.unidbg.linux.android.dvm.apk.Apk;
import com.github.unidbg.linux.android.dvm.array.ArrayObject;
import com.github.unidbg.linux.android.dvm.array.ByteArray;
import com.github.unidbg.linux.android.dvm.wrapper.DvmBoolean;
import com.github.unidbg.linux.android.dvm.wrapper.DvmInteger;
import com.github.unidbg.memory.Memory;
import com.github.unidbg.virtualmodule.android.AndroidModule;
import net.dongliu.apk.parser.bean.CertificateMeta;

import java.io.File;
import java.io.InputStream;
import java.lang.reflect.Field;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;
import java.util.zip.ZipEntry;
import java.util.zip.ZipFile;

public class KSEmulator extends AbstractJni implements IOResolver {
    private final AndroidEmulator emulator;
    private final Module module;
    private final VM vm;
    private final DvmObject<?> context;  // ÂÖ±‰∫´ÁöÑContextÂØπË±°
    private static final String ENC_DATA_REQUEST_HEX;
    private static final String ENC_DATA_EXPECTED_HEX;

    static {
        ENC_DATA_REQUEST_HEX = "7B22617070496E666F223A7B226170704964223A226B75616973686F755F6E6562756C61222C226E616D65223A22E5BFABE6898BE69E81E9809FE78988222C227061636B6167654E616D65223A22636F6D2E6B75616973686F752E6E6562756C61222C2276657273696F6E223A2231332E382E34302E3130363537222C2276657273696F6E436F6465223A2D317D2C22646576696365496E666F223A7B226F616964223A2237303045443638363530454634394543423638364232414141393939344331446361333163373739656535616362376434633362303333333735393961353931222C226F7354797065223A312C226F7356657273696F6E223A223135222C226C616E6775616765223A227A68222C226465766963654964223A22414E44524F49445F62373434323334643665353938373862222C2273637265656E53697A65223A7B227769647468223A313038302C22686569676874223A323230387D2C22667474223A22222C22737570706F72744779726F73636F7065223A747275657D2C226E6574776F726B496E666F223A7B226970223A223139322E3136382E35302E323134222C22636F6E6E656374696F6E54797065223A3130307D2C2267656F496E666F223A7B226C61746974756465223A302C226C6F6E676974756465223A307D2C2275736572496E666F223A7B22757365724964223A2231353739343532343930222C22616765223A302C2267656E646572223A22227D2C22696D70496E666F223A5B7B22706167654964223A31313130312C22737562506167654964223A3130303032343036342C22616374696F6E223A302C227769647468223A302C22686569676874223A302C2262726F77736554797065223A332C22726571756573745363656E6554797065223A312C226C61737452656365697665416D6F756E74223A302C22696D7045787444617461223A227B5C226F70656E48354164436F756E745C223A302C5C2273657373696F6E4C6F6F6B6564436F6D706C65746564436F756E745C223A5C22305C222C5C2273657373696F6E547970655C223A5C22315C222C5C226E656F506172616D735C223A5C2265794A775957646C535751694F6A45784D5441784C434A7A64574A515957646C535751694F6A45774D4441794E4441324E4377696347397A535751694F6A4173496D4A3163326C755A584E7A535751694F6A59774E6977695A586830554746795957317A496A6F694F545930597A59324D575131593255785A44517A4D6D497A4D544A69596A686A4E4755795A47457A4F47497A4E4755304D4445354E7A67344D5459774F4749784F5751325A44497A4F5745784D444D794F444D324F574A6A4E47526D4D4467344E7A5A6A4D4451324E44466A5A44417A4D574935595455355A475A695A6A59334D324E6A4E3249344F4449344D7A67334D6A55784E7A566B5932466A4D7A67314D6A63355A5751315A5759334E7A4A6B5A5467305954497A4F546C695A5463324F545269595452694F544E6A4E6A59334F4455334D6D466C4D444E6D597A51354D5441304D6D49344D7A686C4D474A6A4D6D55315A474E68597A46684E444D77496977695933567A64473974524746305953493665794A6C65476C305357356D6279493665794A306232467A6445526C63324D694F6D353162477773496E527659584E305357316E56584A73496A70756457787366583073496E426C626D5268626E52556558426C496A6F784C434A6B61584E776247463556486C775A5349364D69776963326C755A32786C5547466E5A556C6B496A6F774C434A7A6157356E6247565464574A515957646C535751694F6A4173496D4E6F595735755A5777694F6A4173496D4E76645735305A473933626C4A6C63473979644349365A6D467363325573496E526F5A57316C56486C775A5349364D43776962576C345A5752425A4349365A6D467363325573496D5A316247784E6158686C5A43493664484A315A5377695958563062314A6C634739796443493664484A315A5377695A6E4A7662565268633274445A5735305A5849694F6D5A6862484E6C4C434A7A5A5746795932684A626E4E7761584A6C55324E6F5A57316C5357356D62794936626E5673624377695957317664573530496A6F7766515C227D222C226D6564696145787444617461223A227B7D222C2273657373696F6E223A227B5C2269645C223A5C2261644E656F2D313537393435323439302D3130303032343036342D313736303538333837353938385C227D227D5D2C226164436C69656E74496E666F223A227B5C226970647849505C223A5C223138332E34322E3136342E345C227D222C227265636F5265706F7274436F6E74657874223A227B5C226164436C69656E74496E666F5C223A7B5C2273686F756C6453686F77416450726F66696C6553656374696F6E42616E6E65725C223A6E756C6C2C5C2270726F66696C65417574686F7249645C223A307D7D227D";
        ENC_DATA_EXPECTED_HEX = "5A54EECDE4D4EA6193F79DB96E3254547C68770002477963823030FAD0F3D666690F63A1247249634A4A77BB399B1F3E5CC4518BB302137052CB534DC48E9BCB0850B9E265E1857C40336C08E36E308EE6E7D5D7EEBC9CAD7CF964F6CE6CC0452E9DB776A205F3A0E8E7701B177BB80DDD95B24FB50739215088EE729036819EA0F37EDFE56CF5F5C9B3FF8654822F88841C1939E8F9B8000A6ECF4E88740103CFE2F190F5B68C480F432EF2EA5EB43CC373C0621AE864858F76355FED5400369518C21F92BCD3ACEE033C77E18753C485CC238C44BE2F7AD24AC78C2691998121EE0508DD4F7EE82CB6E7D059F3FA086312BC4094AF2A88C32D523DC50DFCEF84916D4A537ED2679CAE5904C1D6CE9C5A4374DC9B17231528D83226629A2D7375F6C17B632C0687FDACDB393BAA046830C6E24A458F162375C090F13B3B8433F3AC417BA55E012A8FEF579B4D896533E7C75B29AC470C564209581B5AB1FC6ACDC814D4E11EAC839009E9B4D44990140E3BCA24993DFCB02E0FE5B1710F996AB09EEFFD3BEE79C44705B89269F6925410B4223A94274194932AF795E15DF0854946EE1E4A836F98A515506C73AC59A763E305EEA6BABBD3B20F4A5D3FC981749D4F45EAE1F01A83C21C919CF86732235D1D25E897BCD90547BED8835FD7ACF312FBC151096FD7AEC5935D61601DDE57D87D38C43D75BE2ED75C3221185FF4AA616C8EEB3399E22A2F4732C12D7731B1DD843E87BED94E49CA739D220C97831BF900580711280DBC50110B81B9F932C3C86B43293C1FDA6428DFF9827D3D423919A581FAD0BD63DB32B16A3A53B7892B035816B71EA4D50FCD916D5FA34652923D8BB9EA33A92AFBC069BB6704A1C09FFE6C70FEAEB6D50228C7D4EE5CEE2F29F5F858E0C93D5A413BCBBC35996B89062EAD174922577B276F46DC607F27A38E8AF17D1DECB6853DB0ACA12909153EAE4071443E23EA6119B5D08DC7C9AF03481BF40D0BAEB489B18ED83B1ED17BEA830E344690089712FAC76E3FD294DC62AF2106BF9FF81EC0452F6AA10FC3450D5392F76611B6529146CB85BA025D49E9EB0A95E7010C27EE108F2875899F29D21C62F568FE759B2B3FBE95E7DEE292D3C60906DF2F757837B8A3904C95AB2D80E7F006D8318E2EB817C10410194FD79908D1EC5A72C4F21FA0BC096A622F8CE6EEE4C90880EAE43D0FE267C6D75CAC5EA4514E4E0B54F943CBBE654E6ECFB61C792DF9E0EE6373F1C63D6E3810563D80A3CF22A7C42FE32BA5F577337CD9349921C59A033ACAFBE4EB6C098CCEDD19A7A23E4A7BD3FA3A7740B6B7A94CEF9247A9C3F5D5346337C54626372C262357826ECDA163820B82D9B07B24E3CC57777BA06061D74B5D5276DDE3D3FA8E5C8BA711E8EAB68314DA70D70BE132925763BFF61E4E32556EC5C916E550EDAD2CA4443F173D0F316C28511A3318EB98863C3260A1261DDA4B628834C03FD567792BD034D5B9B7384828F4D86E0042583A428118D535CDB0C27CBF3778EA7CD40BA95970046AA826E26237F57B36D2C13BF7EC6FE489E181FC8F311CB1272C507EECD9E244326D220CE6DD3DE5B9CEA2AF03A58E9B0DFB5AE112733E9DEDD0F76A4948F4ACFDCE0E9C0AD7577E0F16C66950E1A0AFD4F53763298B3EE89251FFD32F7DC107E4841AED8924DCD2AD7B6A45121D02A1EFF35D1ED48C72C01E18CE4BC7F82CE45B27AE3D7E46990C20F5FCA7CD5577F5CD4BAA89708360A154BD2AA25C52891362196ACB782F0C980D0ECD2EF21C9B7AEE8E72EC4597D7248EB17F9198B10983034412DCAB1C0701907E603EFFC61BF5870F20272855C5FF0419FEC93FB7FB4632B1AB6B7474A11E114F79E2BB13BD63C7A8FB1E9E7C031B2FABC26F6C072D10C30D48031F6A3BCC02126BFECB9660F9AE55AF85FC0149E5BEA6E1FD5A9DE68C6CF233AE01C1FA39F8FCEA6EE5B83670E3AD9E1C553B9F1BBCA2F27CDB1BC7CC4D3AA9FC4E4362FEE8BE06BEDE4A5795D074E8A4B73745149F12B76636D83BBB99B7A921AD618EBC49C02C4E77E6BC1AF00798C71707117C81555E50A46910114624AF92B1195586228D5EE8E8FCE8FA9974922283156A87547CA80098EBF5D0C965CBE1441B7F653AC88F8568D704EACB5A27F57D1B6C803A7991ED474D4FB8148399A6A6EE2ED7969FC2013DDAC6C320B51F6A4BDF517B7871F8C030FD214E10E5D072CC0F9423A02E9444CAF9B8AE09ABB027D025405DC81F191AC39B41F5B09D48F70851A3FA7E7F685DD52AB4E756F15E4AA97700F5D9CF0A052BD05B74533FF85E92BAA7BE9ADBA5C9FBF9F87AFB3210457AF4C3BCA96B2EEEF082F24C72DFB5B3272FD130258C1A836A2B7FD74AFDF928E2A90F9EC94EA1DDB3DF76CC03F9A3191FDEDFAE731C9879B077CB26CBC62F579D56BF301244ECCADB7137D1D97231960ECCB5E7BEAF632A62CE30ED76BA2AD8152FF55D8769DD4D89C5F489687F4AB3D07FE0E08A734E0135770F2D0985DCC5B646E66A25EC8D16BC1E0F6D5C1FC0BD9E4F8971FDA7A88762178B698CE809113F5DF6D224DACF9B9472A3B376092F48C602F16FD2687468A90D884D79835D7585A1D8";
    }

    public KSEmulator() {
        // ‚ö†Ô∏è Á¨¨‰∏ÄÊ≠•ÔºöÂÖàËØªÂèñAPKÊñá‰ª∂ÔºåËé∑ÂèñÁúüÂÆûÂåÖÂêç
        // ‚ö†Ô∏è ‰ΩøÁî®Âø´ÊâãÊûÅÈÄüÁâàÁöÑAPKÔºàcom.smile.gifmakerÔºâ
        File apkFile = new File("/Users/yml/IdeaProjects/unidbg_1/unidbg-android/apks/ksjsb/ksjsb_13.8.40.10657.apk");
        String realPackageName = getRealPackageName(apkFile);
        System.out.println("\n[üîç APKËØäÊñ≠] APKÁúüÂÆûÂåÖÂêç: " + realPackageName);
        System.out.println("[üîç APKËØäÊñ≠] ‚ö†Ô∏è Ê≥®ÊÑèÔºöÂ¶ÇÊûúÁúüÂÆûÂåÖÂêçÊòØ com.smile.gifmakerÔºåÈúÄË¶ÅÂú®ÊâÄÊúâÂú∞Êñπ‰ΩøÁî®ÂÆÉÔºÅ");
        
        emulator = AndroidEmulatorBuilder
                .for64Bit()
                .addBackendFactory(new Unicorn2Factory(true))
                .setProcessName(realPackageName)  // ‰ΩøÁî®ÁúüÂÆûÂåÖÂêç
                .build();
        Memory memory = emulator.getMemory();
        memory.setLibraryResolver(new AndroidResolver(23));

        vm = emulator.createDalvikVM(apkFile);
        vm.setJni(this);
        vm.setVerbose(true);

        // ‚ö†Ô∏è ÂÖ≥ÈîÆ‰øÆÂ§çÔºöVM ÂàõÂª∫ÂêéÁ´ãÂç≥ÊõøÊç¢Á≠æÂêçÔºàÂøÖÈ°ªÂú®Á≠æÂêçË¢´‰ΩøÁî®‰πãÂâçÔºâ
//        replaceApkWithCustomSignature(apkFile);

        // Ê∑ªÂä†IOResolver - ÂøÖÈ°ªÂú®Âä†ËΩΩÂ∫ì‰πãÂâç
        emulator.getSyscallHandler().addIOResolver(this);

        // Ê≥®ÂÜåAndroidModule - ÂøÖÈ°ªÂú®Âä†ËΩΩÂ∫ì‰πãÂâç
        new AndroidModule(emulator, vm).register(memory);

        // ÂàõÂª∫ÂÖ±‰∫´ÁöÑContextÂØπË±°
        context = vm.resolveClass("com/yxcorp/gifshow/App").newObject(null);
        vm.addGlobalObject(context);  // Ê∑ªÂä†‰∏∫ÂÖ®Â±ÄÂØπË±°ÔºåÈò≤Ê≠¢Ë¢´ÂõûÊî∂

        System.out.println("[ÂàùÂßãÂåñ] ÂºÄÂßãÂä†ËΩΩ SO Â∫ì...");
        DalvikModule dm = vm.loadLibrary("kwsgmain", true);
        module = dm.getModule();
        System.out.println("[ÂàùÂßãÂåñ] SO base: 0x" + Long.toHexString(module.base));
        System.out.println("[ÂàùÂßãÂåñ] SO size: 0x" + Long.toHexString(module.size));

        System.out.println("[ÂàùÂßãÂåñ] Ë∞ÉÁî® JNI_OnLoad...");
        dm.callJNI_OnLoad(emulator);

        // ÂêØÁî®GOT‰øÆÂ§ç - Â∞ÜGOTË°®È°πÊåáÂêëAndroidModuleÁöÑÁúüÂÆûÂÆûÁé∞
        fixGotTable();
        
        // ‚ö†Ô∏è ÂÖ≥ÈîÆÔºöÂú®ÂàùÂßãÂåñÈò∂ÊÆµÂ∞±ËÆæÁΩÆÂÖ®Â±ÄÊ†áÂøó‰Ωç
        System.out.println("[ÂàùÂßãÂåñ] üîß ËÆæÁΩÆÂÖ®Â±ÄÂÆâÂÖ®Ê†áÂøó‰ΩçÔºàÊèêÂâçÂà∞ÂàùÂßãÂåñÈò∂ÊÆµÔºâ...");
        setGlobalFlagsEarly();

        System.out.println("[ÂàùÂßãÂåñ] ‚úì ÂàùÂßãÂåñÂÆåÊàê\n");


    }

    /**
     * Âú®ÂàùÂßãÂåñÈò∂ÊÆµÊèêÂâçËÆæÁΩÆÂÖ®Â±ÄÊ†áÂøó‰Ωç
     * ÂøÖÈ°ªÂú® JNI_OnLoad ‰πãÂêé„ÄÅÁ¨¨‰∏ÄÊ¨°Ë∞ÉÁî® doCommandNative ‰πãÂâçËÆæÁΩÆ
     */
    private void setGlobalFlagsEarly() {
        Backend backend = emulator.getBackend();
        try {
            // 1. ËÆæÁΩÆ qword_70910 = 0x1800000000000
            long qword_70910_addr = module.base + 0x70910;
            long flagValue = 0x1800000000000L;
            byte[] flagBytes = new byte[8];
            for (int i = 0; i < 8; i++) {
                flagBytes[i] = (byte) ((flagValue >> (i * 8)) & 0xFF);
            }
            backend.mem_write(qword_70910_addr, flagBytes);
            System.out.println("[ÂàùÂßãÂåñ]   ‚úì qword_70910 @ 0x" + Long.toHexString(qword_70910_addr) +
                    " = 0x" + Long.toHexString(flagValue));

            // 2. ËÆæÁΩÆ byte_7091F ÁöÑ bit 5 (0x20)
            long byte_7091F_addr = module.base + 0x7091F;
            byte[] currentByte = backend.mem_read(byte_7091F_addr, 1);
            byte oldValue = currentByte[0];
            currentByte[0] |= 0x20;  // ËÆæÁΩÆ bit 5
            backend.mem_write(byte_7091F_addr, currentByte);
            System.out.println("[ÂàùÂßãÂåñ]   ‚úì byte_7091F @ 0x" + Long.toHexString(byte_7091F_addr) +
                    " = 0x" + Integer.toHexString(currentByte[0] & 0xFF) +
                    " (was 0x" + Integer.toHexString(oldValue & 0xFF) + ")");
        } catch (Exception e) {
            System.out.println("[ÂàùÂßãÂåñ] ‚ùå ËÆæÁΩÆÊ†áÂøó‰ΩçÂ§±Ë¥•: " + e.getMessage());
            e.printStackTrace();
        }
    }

    /**
     * ‰ΩøÁî®ÂèçÂ∞ÑÊõøÊç¢ VM ÂÜÖÈÉ®ÁöÑ Apk ÂÆû‰æãÔºå‰ΩøÂÖ∂ËøîÂõû 944 Â≠óËäÇÁöÑÂéüÂßãÁ≠æÂêç
     * ÂøÖÈ°ªÂú® VM ÂàõÂª∫Âêé„ÄÅÁ≠æÂêçË¢´‰ΩøÁî®ÂâçË∞ÉÁî®
     */
    private void replaceApkWithCustomSignature(File apkFile) {
        try {
            System.out.println("\n[Á≠æÂêçÊõøÊç¢] ÂºÄÂßãÊõøÊç¢ APK Á≠æÂêç...");
            
            // 1. ÂèçÂ∞ÑËé∑Âèñ BaseVM.apk Â≠óÊÆµ
            Field apkField = BaseVM.class.getDeclaredField("apk");
            apkField.setAccessible(true);
            Apk originalApk = (Apk) apkField.get(vm);
            
            System.out.println("[Á≠æÂêçÊõøÊç¢] ÂéüÂßã Apk Á±ªÂûã: " + originalApk.getClass().getName());
            
            // 2. ÂàõÂª∫Ëá™ÂÆö‰πâÂåÖË£ÖÂô®
            CustomApkFile customApk = new CustomApkFile(apkFile, originalApk);
            
            // 3. ÊõøÊç¢
            apkField.set(vm, customApk);
            System.out.println("[Á≠æÂêçÊõøÊç¢] ‚úì Â∑≤ÊõøÊç¢‰∏∫ CustomApkFile");
            
            // 4. È™åËØÅÊñ∞Á≠æÂêç
            CertificateMeta[] signatures = vm.getSignatures();
            if (signatures != null && signatures.length > 0) {
                byte[] sigData = signatures[0].getData();
                System.out.println("[Á≠æÂêçÊõøÊç¢] Êñ∞Á≠æÂêçÈïøÂ∫¶: " + sigData.length + " Â≠óËäÇ");
                
                // ËÆ°ÁÆó MD5 Âπ∂ÂØπÊØî
                String md5 = calculateMD5(sigData);
                String expectedMD5 = "046BA25A546A5CAD8E6B6AC6AD31805F";
                
                System.out.println("[Á≠æÂêçÊõøÊç¢] Êñ∞Á≠æÂêç MD5: " + md5);
                System.out.println("[Á≠æÂêçÊõøÊç¢] ÊúüÊúõÁöÑ MD5: " + expectedMD5);
                
                if (expectedMD5.equalsIgnoreCase(md5)) {
                    System.out.println("[Á≠æÂêçÊõøÊç¢] ‚úÖ Á≠æÂêçÂåπÈÖçÊàêÂäüÔºÅ");
                } else {
                    System.out.println("[Á≠æÂêçÊõøÊç¢] ‚ùå Á≠æÂêç‰∏çÂåπÈÖçÔºÅ");
                }
            } else {
                System.out.println("[Á≠æÂêçÊõøÊç¢] ‚ö†Ô∏è Êó†Ê≥ïËé∑ÂèñÁ≠æÂêçËøõË°åÈ™åËØÅ");
            }
            
        } catch (Exception e) {
            System.out.println("[Á≠æÂêçÊõøÊç¢] ‚ùå ÊõøÊç¢Â§±Ë¥•: " + e.getMessage());
            e.printStackTrace();
        }
    }

    /**
     * ËÆ°ÁÆóÂ≠óËäÇÊï∞ÁªÑÁöÑ MD5 ÂìàÂ∏åÂÄº
     */
    private String calculateMD5(byte[] data) {
        try {
            java.security.MessageDigest md = java.security.MessageDigest.getInstance("MD5");
            byte[] hash = md.digest(data);
            return bytesToHex(hash);
        } catch (Exception e) {
            return "ERROR";
        }
    }

    /**
     * Ëá™ÂÆö‰πâ Apk ÂÆûÁé∞ÔºåËøîÂõû‰ªé ZIP Áõ¥Êé•ËØªÂèñÁöÑ 944 Â≠óËäÇÁ≠æÂêç
     */
    private static class CustomApkFile implements Apk {
        private final File apkFile;
        private final Apk delegate;
        private byte[] cachedSignature;

        public CustomApkFile(File apkFile, Apk delegate) {
            this.apkFile = apkFile;
            this.delegate = delegate;
        }

        @Override
        public CertificateMeta[] getSignatures() {
            if (cachedSignature == null) {
                cachedSignature = readSignatureFromZip();
            }
            
            if (cachedSignature != null) {
                return new CertificateMeta[] { new CustomCertificateMeta(cachedSignature) };
            }
            
            // ÈôçÁ∫ßÂà∞ÈªòËÆ§ÂÆûÁé∞
            return delegate.getSignatures();
        }

        /**
         * Áõ¥Êé•‰ªé APK ÁöÑ ZIP ÁªìÊûÑ‰∏≠ËØªÂèñÁ≠æÂêçÊñá‰ª∂
         */
        private byte[] readSignatureFromZip() {
            try (ZipFile zipFile = new ZipFile(apkFile)) {
                // Âø´Êâã‰ΩøÁî®ÁöÑÁ≠æÂêçÊñá‰ª∂Âêç
                ZipEntry entry = zipFile.getEntry("META-INF/CAOHE_KE.RSA");
                if (entry == null) {
                    System.out.println("[CustomApkFile] ‚ö†Ô∏è Êâæ‰∏çÂà∞ META-INF/CAOHE_KE.RSA");
                    return null;
                }
                
                byte[] signatureData = new byte[(int) entry.getSize()];
                try (InputStream is = zipFile.getInputStream(entry)) {
                    int bytesRead = is.read(signatureData);
                    if (bytesRead != signatureData.length) {
                        System.out.println("[CustomApkFile] ‚ö†Ô∏è Á≠æÂêçËØªÂèñ‰∏çÂÆåÊï¥");
                        return null;
                    }
                }
                
                System.out.println("[CustomApkFile] ‚úì ÊàêÂäüËØªÂèñÁ≠æÂêç: " + signatureData.length + " Â≠óËäÇ");
                return signatureData;
                
            } catch (Exception e) {
                System.out.println("[CustomApkFile] ‚ùå ËØªÂèñÁ≠æÂêçÂ§±Ë¥•: " + e.getMessage());
                e.printStackTrace();
                return null;
            }
        }

        // ÂßîÊâòÂÖ∂‰ªñÊñπÊ≥ïÁªôÂéüÂßãÂÆûÁé∞
        @Override public String getVersionName() { return delegate.getVersionName(); }
        @Override public long getVersionCode() { return delegate.getVersionCode(); }
        @Override public String getManifestXml() { return delegate.getManifestXml(); }
        @Override public byte[] openAsset(String fileName) { return delegate.openAsset(fileName); }
        @Override public String getPackageName() { return delegate.getPackageName(); }
        @Override public File getParentFile() { return delegate.getParentFile(); }
        @Override public byte[] getFileData(String path) { return delegate.getFileData(path); }
    }

    /**
     * Ëá™ÂÆö‰πâ CertificateMetaÔºåÁõ¥Êé•ËøîÂõûÂéüÂßãÁ≠æÂêçÊï∞ÊçÆ
     */
    private static class CustomCertificateMeta extends CertificateMeta {
        private final byte[] rawData;

        public CustomCertificateMeta(byte[] rawData) {
            // Ë∞ÉÁî®Áà∂Á±ªÊûÑÈÄ†ÂáΩÊï∞ÔºåÊèê‰æõÊâÄÈúÄÁöÑ7‰∏™ÂèÇÊï∞
            super(
                "SHA1withRSA",  // signAlgorithm
                "CN=Unknown",    // certBase64Md5
                new java.util.Date(1311148114000L), // startDate: 2011-07-20
                new java.util.Date(4657545714000L), // endDate: 2117-07-20
                rawData,         // data
                "CN=Unknown",    // certMd5
                "CN=Unknown"     // publicKeyString
            );
            this.rawData = rawData;
        }

        @Override
        public byte[] getData() {
            return rawData;
        }
    }
    
    /**
     * ËÆæÁΩÆÂÖ®Â±ÄÁä∂ÊÄÅÊ†áÂøó‰ΩçÔºàÂ∑≤Â∫üÂºÉÔºåÁî± setGlobalFlagsEarly Êõø‰ª£Ôºâ
     * Ê†πÊçÆ IDA ÂàÜÊûêÔºåopcode 10400 (Âä†ÂØÜ) ÈúÄË¶ÅÊ£ÄÊü•‰∏§‰∏™ÂÖ≥ÈîÆÊ†áÂøóÔºö
     * 1. qword_70910 ÈúÄË¶ÅËÆæÁΩÆ 0x1800000000000 (ÈîôËØØ70012Ê£ÄÊü•)
     * 2. byte_7091F ÁöÑ bit 5 (0x20) ÂøÖÈ°ªËÆæÁΩÆ (ÈîôËØØ70117Ê£ÄÊü•)
     */
    @Deprecated
    private void setGlobalFlags() {
        Backend backend = emulator.getBackend();
        System.out.println("\n[ÂÖ®Â±ÄÊ†áÂøó] ÂºÄÂßãËÆæÁΩÆÂÆâÂÖ®Ê†áÂøó‰Ωç...");

        try {
            // 1. ËÆæÁΩÆ qword_70910 = 0x1800000000000
            long qword_70910_addr = module.base + 0x70910;
            long flagValue = 0x1800000000000L;
            byte[] flagBytes = new byte[8];
            for (int i = 0; i < 8; i++) {
                flagBytes[i] = (byte) ((flagValue >> (i * 8)) & 0xFF);
            }
            backend.mem_write(qword_70910_addr, flagBytes);
            System.out.println("[ÂÖ®Â±ÄÊ†áÂøó]   ‚úì qword_70910 @ 0x" + Long.toHexString(qword_70910_addr) +
                    " = 0x" + Long.toHexString(flagValue));

            // 2. ËÆæÁΩÆ byte_7091F ÁöÑ bit 5 (0x20)
            long byte_7091F_addr = module.base + 0x7091F;
            byte[] currentByte = backend.mem_read(byte_7091F_addr, 1);
            byte oldValue = currentByte[0];
            currentByte[0] |= 0x20;  // ËÆæÁΩÆ bit 5
            backend.mem_write(byte_7091F_addr, currentByte);
            System.out.println("[ÂÖ®Â±ÄÊ†áÂøó]   ‚úì byte_7091F @ 0x" + Long.toHexString(byte_7091F_addr) +
                    " = 0x" + Integer.toHexString(currentByte[0] & 0xFF) +
                    " (was 0x" + Integer.toHexString(oldValue & 0xFF) + ")");

            System.out.println("[ÂÖ®Â±ÄÊ†áÂøó] ‚úì ÊâÄÊúâÂÆâÂÖ®Ê†áÂøóÂ∑≤ËÆæÁΩÆ\n");
        } catch (Exception e) {
            System.out.println("[ÂÖ®Â±ÄÊ†áÂøó] ‚ùå ËÆæÁΩÆÂ§±Ë¥•: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private void call_doCommandNative_sig3(String text) {
        List<Object> params = new ArrayList<>();
        params.add(vm.getJNIEnv());
        params.add(0);
        params.add(10418);
        StringObject str = new StringObject(vm, text);
        vm.addLocalObject(str);
        ArrayObject strArray = new ArrayObject(str);
        StringObject key1 = new StringObject(vm, "d7b7d042-d4f2-4012-be60-d97ff2429c17");
        vm.addLocalObject(key1);
        DvmInteger dInt = DvmInteger.valueOf(vm, -1);
        vm.addLocalObject(dInt);
        DvmBoolean dBoolean = DvmBoolean.valueOf(vm, false);
        vm.addLocalObject(dBoolean);
        DvmObject<?> dClass = vm.resolveClass("com/yxcorp/gifshow/App").newObject(null);
        vm.addLocalObject(dClass);
        StringObject key2 = new StringObject(vm, "");
        vm.addLocalObject(key2);
        ArrayObject paramArray = new ArrayObject(strArray, key1, dInt, dBoolean, dClass, null, dBoolean, key2);
        params.add(vm.addLocalObject(paramArray));
        Number number = module.callFunction(emulator, 0x40cd4, params.toArray());
        DvmObject<?> object = vm.getObject(number.intValue());
        String result = (String) object.getValue();
        System.out.println("result:" + result);
    }

    public static void main(String[] args) {
        KSEmulator emulator = new KSEmulator();
        
        // Á≠ñÁï•1ÔºöÊ≠£Â∏∏ÂàùÂßãÂåñÊµÅÁ®ã
        System.out.println("\n========== Á¨¨1Ê≠•ÔºöÂàùÂßãÂåñÁéØÂ¢É ==========");
        String initResult = emulator.call_doCommandNative_init();
        System.out.println("[‰∏ªÊµÅÁ®ã] ÂàùÂßãÂåñÁªìÊûú: " + initResult);

        if (initResult == null || !initResult.equals("1")) {
            System.out.println("[‰∏ªÊµÅÁ®ã] ‚ö†Ô∏è ÂàùÂßãÂåñËøîÂõû0Ôºå‰ΩÜÂ∞ùËØïÁªßÁª≠ÊâßË°åÔºàÁ≠æÂêçÂ∑≤ÈÄöËøáÔºâ");
            // ‰∏çË¶Å returnÔºåÁªßÁª≠ÊâßË°å
        }

        // Á≠ñÁï•2ÔºöÂ∞ùËØïÁõ¥Êé•Âä†ÂØÜÔºàÂÖ®Â±ÄÊ†áÂøó‰ΩçÂ∑≤Âú®ÊûÑÈÄ†ÂáΩÊï∞‰∏≠ËÆæÁΩÆÔºâ
        System.out.println("\n========== Á¨¨2Ê≠•ÔºöÂä†ÂØÜÊï∞ÊçÆ ==========");
        String encResult = emulator.encryptEncData();

        if (encResult != null) {
            System.out.println("[‰∏ªÊµÅÁ®ã] ‚úì Âä†ÂØÜÊàêÂäü");
            System.out.println("[‰∏ªÊµÅÁ®ã] Âä†ÂØÜÁªìÊûúÈïøÂ∫¶: " + encResult.length());
            
            // È™åËØÅÁªìÊûú
            if (ENC_DATA_EXPECTED_HEX.equalsIgnoreCase(encResult)) {
                System.out.println("[‰∏ªÊµÅÁ®ã] üéâ Âä†ÂØÜÁªìÊûúÂÆåÂÖ®ÂåπÈÖçÔºÅ");
            } else {
                System.out.println("[‰∏ªÊµÅÁ®ã] ‚ö†Ô∏è Âä†ÂØÜÁªìÊûú‰∏çÂåπÈÖç");
                System.out.println("[‰∏ªÊµÅÁ®ã] ÊúüÊúõÈïøÂ∫¶: " + ENC_DATA_EXPECTED_HEX.length());
                System.out.println("[‰∏ªÊµÅÁ®ã] ÂÆûÈôÖÈïøÂ∫¶: " + encResult.length());
            }
        } else {
            System.out.println("[‰∏ªÊµÅÁ®ã] ‚ùå Âä†ÂØÜÂ§±Ë¥•");
        }

        System.out.println("\n========== ÊâßË°åÂÆåÊàê ==========\n");
    }


    public String encryptEncData() {
        System.out.println("\n[encryptEncData] ÂºÄÂßãÊâßË°å encData Ë∞ÉÁî®...");

        // ‚ö†Ô∏è ÂÖ≥ÈîÆÂèëÁé∞Ôºöopcode 10400 Âíå 10408 ÂØπÂèÇÊï∞[0]ÁöÑÁ±ªÂûãÊúüÊúõ‰∏çÂêåÔºÅ
        int opcode = 10400;  // ‰ΩøÁî® 10400
        System.out.println("[encryptEncData] opcode: " + opcode);
        System.out.println("[encryptEncData] ‰ΩøÁî®ÂÖ±‰∫´Context: " + context);

        List<Object> list = new ArrayList<>(4);
        list.add(vm.getJNIEnv());
        DvmObject<?> thiz = vm.resolveClass("com/kuaishou/android/security/internal/dispatch/JNICLibrary").newObject(null);
        list.add(vm.addLocalObject(thiz));
        list.add(opcode);

        System.out.println("[encryptEncData] üìä ËØ∑Ê±ÇHexÈïøÂ∫¶: " + ENC_DATA_REQUEST_HEX.length());
        byte[] requestBytes = hexToBytes(ENC_DATA_REQUEST_HEX);
        System.out.println("[encryptEncData] üìä ËØ∑Ê±ÇÂ≠óËäÇÈïøÂ∫¶: " + requestBytes.length);
        
        // È™åËØÅÊï∞ÊçÆÂÆåÊï¥ÊÄß
        String hexPreview = ENC_DATA_REQUEST_HEX.substring(0, Math.min(100, ENC_DATA_REQUEST_HEX.length()));
        System.out.println("[encryptEncData] üìä Êï∞ÊçÆÈ¢ÑËßà: " + hexPreview + "...");
        
        // Ê£ÄÊü•ÁâàÊú¨Âè∑ÔºàÂ∫îËØ•ÂåÖÂê´ "13.8.40.10657" ÁöÑÂçÅÂÖ≠ËøõÂà∂Ë°®Á§∫Ôºâ
        if (ENC_DATA_REQUEST_HEX.contains("31332E382E34302E3130363537")) {
            System.out.println("[encryptEncData] ‚úÖ ÁâàÊú¨Âè∑Ê†°È™åÈÄöËøá: 13.8.40.10657");
        } else if (ENC_DATA_REQUEST_HEX.contains("31322E372E32302E38353032")) {
            System.out.println("[encryptEncData] ‚ö†Ô∏è Ë≠¶ÂëäÔºö‰ΩøÁî®ÁöÑÊòØÊóßÁâàÊú¨ 12.7.20.8502");
        } else {
            System.out.println("[encryptEncData] ‚ö†Ô∏è Ë≠¶ÂëäÔºöÊó†Ê≥ïËØÜÂà´ÁâàÊú¨Âè∑");
        }

        // üîë Ê†πÊçÆÈîôËØØÊó•ÂøóÂàÜÊûê‰∏çÂêå opcode ÁöÑÂèÇÊï∞Á±ªÂûãÔºö
        // - opcode 10400: ÊúüÊúõ ByteArray (DalvikVM64:3176)
        // - opcode 10408: ÊúüÊúõ ArrayObject(StringObject(Hex))
        // - encData.log ÊòæÁ§∫ÁúüÂÆûÁéØÂ¢É‰ΩøÁî®ÁöÑÊòØ Hex Â≠óÁ¨¶‰∏≤

        DvmObject<?> requestParam;
        // opcode 10400: ‰ΩøÁî® ByteArray
        ByteArray requestByteArray = new ByteArray(vm, requestBytes);
        vm.addLocalObject(requestByteArray);
        requestParam = requestByteArray;
        System.out.println("[encryptEncData] ‚úÖ ÂèÇÊï∞[0]: ByteArray (ÈïøÂ∫¶=" + requestBytes.length + ")");

        StringObject appKey = new StringObject(vm, "d7b7d042-d4f2-4012-be60-d97ff2429c17");
        vm.addLocalObject(appKey);

        DvmInteger zero = DvmInteger.valueOf(vm, 0);
        vm.addLocalObject(zero);

        // ‰ΩøÁî®ÂÖ±‰∫´ÁöÑContextÂØπË±°ÔºåËÄå‰∏çÊòØÂàõÂª∫Êñ∞ÁöÑ
        vm.addLocalObject(context);

        DvmBoolean boolTrueFirst = DvmBoolean.valueOf(vm, true);
        vm.addLocalObject(boolTrueFirst);

        StringObject deviceKey = new StringObject(vm, "95147564-9763-4413-a937-6f0e3c12caf1");
        vm.addLocalObject(deviceKey);

        // ÂèÇÊï∞Êï∞ÁªÑÔºö[ArrayObject(ByteArray), String, Integer, null, Context, Boolean, Boolean, String]
        DvmBoolean boolTrueSecond = DvmBoolean.valueOf(vm, true);
        vm.addLocalObject(boolTrueSecond);

        ArrayObject paramsArray = new ArrayObject(
                requestParam,      // [0] ByteArray Êàñ ArrayObject(StringObject(Hex))
                appKey,            // [1] app key
                zero,              // [2] Integer 0
                null,              // [3] null
                context,           // [4] Context
                boolTrueFirst,     // [5] Boolean true
                boolTrueSecond,    // [6] Boolean true
                deviceKey          // [7] device key
        );
        System.out.println("[encryptEncData] ÂèÇÊï∞Êï∞ÁªÑÈïøÂ∫¶: " + 8);
        list.add(vm.addLocalObject(paramsArray));

        System.out.println("[encryptEncData] Âç≥Â∞ÜË∞ÉÁî® doCommandNative (0x40cd4)...");
//        emulator.traceCode();
        Number result = module.callFunction(emulator, 0x40cd4, list.toArray());


        String resultInfo = result == null ? "null" : result + " (0x" + Long.toHexString(result.longValue()) + ")";
        System.out.println("\n[encryptEncData] JNI ÂéüÂßãËøîÂõû: " + resultInfo);
        if (result == null || result.intValue() == -1) {
            System.out.println("[encryptEncData] Ë∞ÉÁî®Â§±Ë¥•ÔºåËøîÂõûÂÄº: " + result);
            return null;
        }

        DvmObject<?> resultObject = vm.getObject(result.intValue());
        System.out.println("[encryptEncData] vm.getObject -> " + resultObject);
        if (resultObject instanceof ByteArray) {
            byte[] encBytes = ((ByteArray) resultObject).getValue();
            String hexResult = bytesToHex(encBytes);
            System.out.println("[encryptEncData] encData Hex: " + hexResult);
            System.out.println("[encryptEncData] ÊòØÂê¶ÂåπÈÖçÊ†∑Êú¨: " + ENC_DATA_EXPECTED_HEX.equalsIgnoreCase(hexResult));
            return hexResult;
        }

        if (resultObject != null) {
            System.out.println("[encryptEncData] ËøîÂõûÂØπË±°Á±ªÂûã: " + resultObject.getClass().getSimpleName() + " ÂÄº: " + resultObject.getValue());
            return String.valueOf(resultObject.getValue());
        }

        System.out.println("[encryptEncData] ËøîÂõûÂØπË±°‰∏∫Á©∫");
        return null;
    }

    private static byte[] hexToBytes(String hex) {
        if (hex == null) {
            throw new IllegalArgumentException("hex string is null");
        }
        int length = hex.length();
        if ((length & 1) != 0) {
            throw new IllegalArgumentException("hex string length must be even");
        }
        byte[] data = new byte[length / 2];
        for (int i = 0; i < length; i += 2) {
            int high = Character.digit(hex.charAt(i), 16);
            int low = Character.digit(hex.charAt(i + 1), 16);
            if (high < 0 || low < 0) {
                throw new IllegalArgumentException("invalid hex character detected");
            }
            data[i / 2] = (byte) ((high << 4) + low);
        }
        return data;
    }

    private static String bytesToHex(byte[] bytes) {
        if (bytes == null || bytes.length == 0) {
            return "";
        }
        char[] hexArray = "0123456789ABCDEF".toCharArray();
        char[] hexChars = new char[bytes.length * 2];
        for (int j = 0; j < bytes.length; j++) {
            int v = bytes[j] & 0xFF;
            hexChars[j * 2] = hexArray[v >>> 4];
            hexChars[j * 2 + 1] = hexArray[v & 0x0F];
        }
        return new String(hexChars);
    }


    private String call_doCommandNative_init() {
        System.out.println("[initializeEnvironment] ‰ΩøÁî®ÂÖ±‰∫´Context: " + context);


        List<Object> list = new ArrayList<>(4);
        list.add(vm.getJNIEnv()); // Á¨¨‚ºÄ‰∏™ÂèÇÊï∞ÊòØenv
        DvmObject<?> thiz = vm.resolveClass("com/kuaishou/android/security/internal/dispatch/JNICLibrary").newObject(null);
        list.add(vm.addLocalObject(thiz)); // Á¨¨‚ºÜ‰∏™ÂèÇÊï∞ÔºåÂÆû‰æã‚ΩÖÊ≥ïÊòØjobjectÔºåÈùôÊÄÅ‚ΩÖÊ≥ïÊòØjclassÔºåÁõ¥Êé•Â°´0Ôºå‚ºÄËà¨‚Ω§‰∏çÂà∞„ÄÇ

        list.add(10412); // opcodeÂèÇÊï∞ - ÂàùÂßãÂåñÂëΩ‰ª§

        // ÊûÑÂª∫ÂèÇÊï∞Êï∞ÁªÑ - ÂèÇËÄÉ encryptEncData ÁöÑÂèÇÊï∞ÁªìÊûÑ
        StringObject appkey = new StringObject(vm, "d7b7d042-d4f2-4012-be60-d97ff2429c17");
        vm.addLocalObject(appkey);

        DvmInteger zero = DvmInteger.valueOf(vm, 0);
        vm.addLocalObject(zero);

        // ÂèÇÊï∞Êï∞ÁªÑÔºö[null, appkey, zero, null, context, null, null]
        // Ê≥®ÊÑèÔºöÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞ÂèØËÉΩÈúÄË¶ÅÊòØ ByteArray ÊàñÂÖ∂‰ªñÁ±ªÂûã
        ArrayObject paramsArray = new ArrayObject(
                null,       // [0] ÂèØËÉΩÈúÄË¶Å ByteArray
                appkey,     // [1] app key
                zero,       // [2] Integer 0
                null,       // [3] null
                context,    // [4] Context
                null,       // [5] null
                null        // [6] null
        );
        list.add(vm.addLocalObject(paramsArray));

        System.out.println("[initializeEnvironment] Ë∞ÉÁî® doCommandNative(opcode=10412)...");
        Number numbers = module.callFunction(emulator, 0x40cd4, list.toArray());


        // ËØ¶ÁªÜÁöÑËøîÂõûÂÄºÂàÜÊûê
        System.out.println("[initializeEnvironment] ÂéüÂßãËøîÂõûÂÄº: " + numbers +
                (numbers != null ? " (0x" + Long.toHexString(numbers.longValue()) + ")" : ""));

        if (numbers == null) {
            System.out.println("[initializeEnvironment] ‚ùå ËøîÂõûÂÄº‰∏∫ null");
            return null;
        }

        int retValue = numbers.intValue();
        System.out.println("[initializeEnvironment] ËøîÂõûÂÄºÊï¥Êï∞: " + retValue);

        if (retValue == 0) {
            System.out.println("[initializeEnvironment] ‚ö† ËøîÂõû 0 Ë°®Á§∫Â§±Ë¥•");
            return null;
        }

        if (retValue == -1) {
            System.out.println("[initializeEnvironment] ‚ùå ËøîÂõû -1 Ë°®Á§∫Â§±Ë¥•");
            return null;
        }

        // Â∞ùËØï‰Ωú‰∏∫ÂØπË±°ÂºïÁî®Ëß£Êûê
        try {
            DvmObject<?> object = vm.getObject(retValue);
            if (object == null) {
                System.out.println("[initializeEnvironment] ËøîÂõûÂÄº‰∏çÊòØÂØπË±°ÂºïÁî®ÔºåÁõ¥Êé•ËøîÂõûÊï¥Êï∞: " + retValue);
                return String.valueOf(retValue);
            }

            String result = (String) object.getValue();
            System.out.println("[initializeEnvironment] ÁªìÊûú: " + result);
            return result;
        } catch (Exception e) {
            System.out.println("[initializeEnvironment] Ëß£ÊûêËøîÂõûÂÄºÂá∫Èîô: " + e.getMessage());
            return null;
        }
    }

    @Override
    public int callIntMethodV(BaseVM vm, DvmObject<?> dvmObject, String signature, VaList vaList) {
        switch (signature) {
            case "java/lang/Integer->intValue()I":
                return ((DvmInteger) dvmObject).getValue();
        }
        return super.callIntMethodV(vm, dvmObject, signature, vaList);
    }

    public boolean callBooleanMethodV(BaseVM vm, DvmObject<?> dvmObject, String signature, VaList vaList) {
        switch (signature) {
            case "java/lang/Boolean->booleanValue()Z":
                return ((DvmBoolean) dvmObject).getValue();
        }
        return super.callBooleanMethodV(vm, dvmObject, signature, vaList);
    }

    @Override
    public void callStaticVoidMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) {
        switch (signature) {
            case "com/kuaishou/android/security/internal/common/ExceptionProxy->nativeReport(ILjava/lang/String;)V": {
                int code = vaList.getIntArg(0);
                String message = vaList.getObjectArg(1).getValue().toString();
                System.out.println("\n[‚ùå nativeReport] ÈîôËØØÁ†Å: 0x" + Integer.toHexString(code) + " (" + code + ")");
                System.out.println("[‚ùå nativeReport] Ê∂àÊÅØ: " + message);
                
                // ÈîôËØØÁ†ÅËß£Êûê
                switch (code) {
                    case 0x11180: // 70016
                        System.out.println("[‚ùå ÂàÜÊûê] 70016 = ÂåÖÂêç/Á≠æÂêç‰∏çÂú®ÁôΩÂêçÂçï‰∏≠");
                        System.out.println("[‚ùå ÊèêÁ§∫] Ê£ÄÊü• Context.getPackageName() ËøîÂõûÂÄº");
                        break;
                    case 0x11178: // 70008
                        System.out.println("[‚ùå ÂàÜÊûê] 70008 = ÂàùÂßãÂåñÁõ∏ÂÖ≥ÈîôËØØ");
                        break;
                    case 0x11172: // 70002
                        System.out.println("[‚ùå ÂàÜÊûê] 70002 = ÁéØÂ¢ÉÊ£ÄÊµãÂ§±Ë¥•");
                        break;
                    case 0x1117e: // 70014
                        System.out.println("[‚ùå ÂàÜÊûê] 70014 = Âä†ÂØÜÂâçÁΩÆÊù°‰ª∂Êú™Êª°Ë∂≥");
                        break;
                    case 0x111e5: // 70117
                        System.out.println("[‚ùå ÂàÜÊûê] 70117 = ÂÖ®Â±ÄÊ†áÂøó‰ΩçÊ£ÄÊü•Â§±Ë¥•");
                        break;
                    case 0x111b7: // 70071
                        System.out.println("[‚ùå ÂàÜÊûê] 70071 = APKË∑ØÂæÑ/Á≠æÂêçÁõ∏ÂÖ≥");
                        break;
                    case 0x111bc: // 70076
                        System.out.println("[‚ùå ÂàÜÊûê] 70076 = Á≠æÂêçÊ†°È™åÁõ∏ÂÖ≥");
                        break;
                }
                System.out.println();
                return;
            }
        }
        super.callStaticVoidMethodV(vm, dvmClass, signature, vaList);
    }


    @Override
    public DvmObject<?> callStaticObjectMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) {
        switch (signature) {
            case "com/kuaishou/android/security/internal/common/ExceptionProxy->getProcessName(Landroid/content/Context;)Ljava/lang/String;": {
                String processName = vm.getPackageName();
                System.out.println("[üîç ËØäÊñ≠] getProcessName() ËøîÂõû: " + processName);
                return new StringObject(vm, processName);
            }
            case "java/lang/System->getProperty(Ljava/lang/String;)Ljava/lang/String;": {
                StringObject keyObj = vaList.getObjectArg(0);
                String key = keyObj.getValue();
                String value = System.getProperty(key);
                System.out.println("[System.getProperty] key: " + key + " => " + value);
                return value != null ? new StringObject(vm, value) : null;
            }
        }
        return super.callStaticObjectMethodV(vm, dvmClass, signature, vaList);
    }

    @Override
    public DvmObject<?> callObjectMethodV(BaseVM vm, DvmObject<?> dvmObject, String signature, VaList vaList) {
        // Ê∑ªÂä†ÈÄöÁî®Êó•ÂøóÊù•ËøΩË∏™ÊâÄÊúâÊñπÊ≥ïË∞ÉÁî®
        if (signature.contains("getPackage") || signature.contains("Signature") || signature.contains("Context")) {
            System.out.println("[üîç ÊñπÊ≥ïË∞ÉÁî®] " + signature + " on " + dvmObject.getClass().getSimpleName());
        }
        
        switch (signature) {
            // ===== Á≠æÂêçÁõ∏ÂÖ≥ÊñπÊ≥ï =====
            case "android/content/pm/Signature->toByteArray()[B": {
                if (dvmObject instanceof Signature) {
                    Signature sig = (Signature) dvmObject;
                    byte[] data = sig.toByteArray();
                    System.out.println("[Signature.toByteArray] ËøîÂõûÁ≠æÂêçÊï∞ÊçÆÔºåÈïøÂ∫¶: " + data.length);
                    return new ByteArray(vm, data);
                }
                System.out.println("[Signature.toByteArray] ‚ö† ÂØπË±°‰∏çÊòØ Signature Á±ªÂûã: " + dvmObject.getClass());
                return null;
            }
            
            case "android/content/pm/Signature->toCharsString()Ljava/lang/String;": {
                String charsStr = ((Signature) dvmObject).toCharsString();
                System.out.println("[üîç Signature.toCharsString] ËøîÂõû: " + charsStr.substring(0, Math.min(50, charsStr.length())) + "...");
                return new StringObject(vm, charsStr);
            }

            // ===== Context Âíå App ÊñπÊ≥ï =====
            case "com/yxcorp/gifshow/App->getPackageCodePath()Ljava/lang/String;": {
                // ‰ΩøÁî®ÁúüÂÆûÂåÖÂêçÊûÑÈÄ†Ë∑ØÂæÑ
                String packageName = vm.getPackageName();
                String path = "/data/app/~~tNMZVmV0fBgOq2lCiMwGRA==/" + packageName + "-JZD_aIoXsKoTPab3p20hBw==/base.apk";
                System.out.println("[üîç getPackageCodePath] ËøîÂõû: " + path);
                return new StringObject(vm, path);
            }
            
            case "com/yxcorp/gifshow/App->getPackageName()Ljava/lang/String;": {
                String packageName = vm.getPackageName();
                System.out.println("[üîç getPackageName] ËøîÂõû: " + packageName);
                return new StringObject(vm, packageName);
            }

            case "com/yxcorp/gifshow/App->getAssets()Landroid/content/res/AssetManager;": {
                return new AssetManager(vm, signature);
            }
            case "com/yxcorp/gifshow/App->getPackageManager()Landroid/content/pm/PackageManager;": {
                return vm.resolveClass("android/content/pm/PackageManager").newObject(signature);
            }
            case "android/content/pm/PackageManager->getPackageInfo(Ljava/lang/String;I)Landroid/content/pm/PackageInfo;": {
                String packageName = (String) vaList.getObjectArg(0).getValue();
                int flags = vaList.getIntArg(1);
                System.out.println("[PackageManager] getPackageInfo(" + packageName + ", " + flags + ")");
                System.out.println("[PackageManager] flagsËß£Êûê: GET_SIGNATURES=" + ((flags & 0x40) != 0) +
                        ", GET_SIGNING_CERTIFICATES=" + ((flags & 0x8000000) != 0));

                // ÂàõÂª∫PackageInfoÔºåÈúÄË¶ÅÂåÖÂê´Á≠æÂêç‰ø°ÊÅØ
                PackageInfo packageInfo = new PackageInfo(vm, packageName, 138401);

                // Â¶ÇÊûúËØ∑Ê±ÇÁ≠æÂêç‰ø°ÊÅØÔºàflagsÂåÖÂê´GET_SIGNATURES=0x40ÔºâÔºåÈúÄË¶ÅËÆæÁΩÆsignaturesÂ≠óÊÆµ
                if ((flags & 0x40) != 0) {
                    System.out.println("[PackageManager] ‚ö† ÈúÄË¶ÅÊèê‰æõAPKÁ≠æÂêç‰ø°ÊÅØ");
                    // TODO: Ê∑ªÂä†ÁúüÂÆûÁöÑAPKÁ≠æÂêç
                }

                return packageInfo;
            }

            case "android/content/Context->getPackageCodePath()Ljava/lang/String;": {
                // ‰ΩøÁî®ÁúüÂÆûÂåÖÂêçÊûÑÈÄ†Ë∑ØÂæÑ
                String packageName = vm.getPackageName();
                String path = "/data/app/~~tNMZVmV0fBgOq2lCiMwGRA==/" + packageName + "-JZD_aIoXsKoTPab3p20hBw==/base.apk";
                System.out.println("[üîç Context.getPackageCodePath] ËøîÂõû: " + path);
                return new StringObject(vm, path);
            }
            
            case "android/content/Context->getPackageName()Ljava/lang/String;": {
                String packageName = vm.getPackageName();
                System.out.println("[üîç Context.getPackageName] ËøîÂõû: " + packageName);
                return new StringObject(vm, packageName);
            }
            case "android/content/Context->getAssets()Landroid/content/res/AssetManager;":
                return new AssetManager(vm, signature);

            // Ê∑ªÂä†Á≠æÂêçÁõ∏ÂÖ≥ÁöÑÊñπÊ≥ï
            case "android/content/pm/PackageInfo->signatures:[Landroid/content/pm/Signature;": {
                System.out.println("[PackageInfo] ËØ∑Ê±ÇsignaturesÂ≠óÊÆµ");
                // ËøîÂõûÁ≠æÂêçÊï∞ÁªÑ
                Signature[] signatures = createMockSignatures(vm);
                return new ArrayObject(signatures);
            }
        }
        return super.callObjectMethodV(vm, dvmObject, signature, vaList);
    }

    /**
     * ÂàõÂª∫Ê®°ÊãüÁöÑAPKÁ≠æÂêçÊï∞ÁªÑ
     * ËøôÊòØÂø´ÊâãÂÆâÂÖ®Â∫ìÈ™åËØÅAPKÂÆåÊï¥ÊÄßÊâÄÂøÖÈúÄÁöÑ
     * <p>
     * Ê≥®ÊÑèÔºöËøô‰∏™ÊñπÊ≥ïÂ∑≤Áªè‰∏çÂÜç‰ΩøÁî®ÔºåÁ≠æÂêçÂ∫îËØ•ÈÄöËøá VM.getSignatures() Ëé∑Âèñ
     * ÂèÇËÄÉ AbstractJni.java Á¨¨150-157Ë°åÁöÑÂÆûÁé∞
     */
    private Signature[] createMockSignatures(VM vm) {
        System.out.println("[Á≠æÂêçÈ™åËØÅ] ‰ªé VM Ëé∑ÂèñÁ≠æÂêç...");

        // ‰ΩøÁî® VM ÂÜÖÁΩÆÁöÑÁ≠æÂêçÊú∫Âà∂
        CertificateMeta[] metas = vm.getSignatures();
        if (metas != null && metas.length > 0) {
            Signature[] signatures = new Signature[metas.length];
            for (int i = 0; i < metas.length; i++) {
                signatures[i] = new Signature(vm, metas[i]);
                // ‚≠ê ÂÖ≥ÈîÆËØäÊñ≠ÔºöËæìÂá∫ÊØè‰∏™Á≠æÂêçÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
                byte[] certData = metas[i].getData();
                System.out.println("[Á≠æÂêçÈ™åËØÅ]   ËØÅ‰π¶ #" + (i+1) + ":");
                System.out.println("[Á≠æÂêçÈ™åËØÅ]     - Êï∞ÊçÆÈïøÂ∫¶: " + certData.length + " Â≠óËäÇ");
                System.out.println("[Á≠æÂêçÈ™åËØÅ]     - Á≠æÂêçÁÆóÊ≥ï: " + metas[i].getSignAlgorithm());
                System.out.println("[Á≠æÂêçÈ™åËØÅ]     - ÂºÄÂßãÊó•Êúü: " + metas[i].getStartDate());
                System.out.println("[Á≠æÂêçÈ™åËØÅ]     - ÁªìÊùüÊó•Êúü: " + metas[i].getEndDate());
                
                // ËÆ°ÁÆóMD5Áî®‰∫éÂØπÊØî
                try {
                    java.security.MessageDigest md = java.security.MessageDigest.getInstance("MD5");
                    byte[] hash = md.digest(certData);
                    System.out.println("[Á≠æÂêçÈ™åËØÅ]     - MD5: " + bytesToHex(hash));
                } catch (Exception e) {
                    System.out.println("[Á≠æÂêçÈ™åËØÅ]     - MD5: ËÆ°ÁÆóÂ§±Ë¥•");
                }
            }
            System.out.println("[Á≠æÂêçÈ™åËØÅ] ‚úì ÊàêÂäüËé∑Âèñ " + signatures.length + " ‰∏™Á≠æÂêç");
            return signatures;
        }

        System.out.println("[Á≠æÂêçÈ™åËØÅ] ‚ö† VM ‰∏≠Ê≤°ÊúâÁ≠æÂêçÊï∞ÊçÆÔºåÈúÄË¶ÅÂú®ÂàõÂª∫ VM Êó∂ËÆæÁΩÆ");
        return new Signature[0];
    }

    @Override
    public DvmObject<?> getObjectField(BaseVM vm, DvmObject<?> dvmObject, String signature) {
        System.out.println("[getObjectField] ËØ∑Ê±ÇÂ≠óÊÆµ: " + signature + " from " + dvmObject.getClass().getSimpleName());

        switch (signature) {
            case "android/content/pm/PackageInfo->signatures:[Landroid/content/pm/Signature;": {
                System.out.println("[getObjectField] ËøîÂõûÁ≠æÂêçÊï∞ÁªÑ");
                Signature[] signatures = createMockSignatures(vm);
                return new ArrayObject(signatures);
            }
        }

        return super.getObjectField(vm, dvmObject, signature);
    }

    /**
     * IOResolverÊé•Âè£ÂÆûÁé∞ - Â§ÑÁêÜÊñá‰ª∂Á≥ªÁªüËÆøÈóÆ
     * Ê†πÊçÆ„ÄäÂÆâÂçìÈÄÜÂêëËøôÊ°£‰∫ã„ÄãÁ¨¨25ËØæÊïôÁ®ãË°•ÂÖÖÂÆåÊï¥ÁöÑÊñá‰ª∂ËÆøÈóÆÂ§ÑÁêÜ
     *
     * ÂÖ≥ÈîÆÊñá‰ª∂‰ºòÂÖàÁ∫ßÔºö
     * 1. /proc/self/maps - APKË∑ØÂæÑÊü•ÊâæÂíåÂÆåÊï¥ÊÄßÊ†°È™åÔºàÂøÖÈ°ªÔºâ
     * 2. /proc/self/status - ÂèçË∞ÉËØïÊ£ÄÊµã TracerPidÔºàÂøÖÈ°ªÔºâ
     * 3. /proc/self/cmdline - ËøõÁ®ãÂêçÊ†°È™åÔºàÂøÖÈ°ªÔºâ
     * 4. base.apk - Á≠æÂêçÊ†°È™åÂíåËµÑÊ∫êËÆøÈóÆÔºàÂøÖÈ°ªÔºâ
     */
    @Override
    public FileResult resolve(Emulator emulator, String pathname, int oflags) {
        if (pathname == null) {
            System.out.println("[IOResolver] pathname is NULL");
            return null;
        }

        // Ê£ÄÊµãÂπ∂ÂøΩÁï•Êó†ÊïàË∑ØÂæÑÔºàÂÜÖÂ≠òÂú∞ÂùÄË¢´ËØØÂΩì‰ΩúÂ≠óÁ¨¶‰∏≤Ôºâ
        if (pathname.length() < 10 && pathname.contains("\ufffd")) {
            // \ufffd ÊòØ Unicode ÊõøÊç¢Â≠óÁ¨¶ÔºåË°®Á§∫Êó†ÊïàÁöÑÂ≠óËäÇÂ∫èÂàó
            System.out.println("[IOResolver] ÂøΩÁï•Êó†ÊïàË∑ØÂæÑÔºàÂÜÖÂ≠òÂú∞ÂùÄÔºâ: " + pathname);
            // üîç Ë∞ÉËØïÔºöÊâìÂç∞Ë∞ÉÁî®Â†ÜÊ†à
            Backend backend = emulator.getBackend();
            long pc = backend.reg_read(unicorn.Arm64Const.UC_ARM64_REG_PC).longValue();
            long lr = backend.reg_read(unicorn.Arm64Const.UC_ARM64_REG_LR).longValue();
            System.out.println("[IOResolver]   Ë∞ÉÁî®‰ΩçÁΩÆ: PC=0x" + Long.toHexString(pc) +
                             " LR=0x" + Long.toHexString(lr) +
                             " (offset=0x" + Long.toHexString(lr - module.base) + ")");
            return null;
        }

        System.out.println("[IOResolver] ËØ∑Ê±ÇÊâìÂºÄÊñá‰ª∂: " + pathname);

        // ========== 1. Â§ÑÁêÜAPKË∑ØÂæÑÔºàÁ≠æÂêçÊ†°È™åÂøÖÈúÄÔºâ ==========
        if (pathname.contains("/base.apk")) {
            File apkFile = new File("/Users/yml/IdeaProjects/unidbg_1/unidbg-android/apks/ksjsb/ksjsb_13.8.40.10657.apk");
            if (apkFile.exists()) {
                System.out.println("[IOResolver] ‚úì ËøîÂõûAPKÊñá‰ª∂");
                return FileResult.success(new com.github.unidbg.linux.file.SimpleFileIO(oflags, apkFile, pathname));
            } else {
                System.out.println("[IOResolver] ‚ùå APKÊñá‰ª∂‰∏çÂ≠òÂú®: " + apkFile.getAbsolutePath());
            }
        }

        // ========== 2. Â§ÑÁêÜÂÖ≥ÈîÆÁ≥ªÁªüÊñá‰ª∂ ==========
        switch (pathname) {
            // ---------- /proc/self/cmdline: ËøõÁ®ãÂêçÊ†°È™å ----------
            case "/proc/self/cmdline": {
                System.out.println("[IOResolver] ‚úì ËøîÂõûËøõÁ®ãÂêçÔºà‰ΩøÁî®VMÂåÖÂêçÔºâ");
                // ‰ΩøÁî®VMÁöÑÂåÖÂêçÔºà‰ªéAPKËØªÂèñÁöÑÁúüÂÆûÂåÖÂêçÔºâ
                String packageName = vm.getPackageName();
                return FileResult.success(new ByteArrayFileIO(oflags, pathname,
                        packageName.getBytes(StandardCharsets.UTF_8)));
            }

            // ---------- /proc/self/status: ÂèçË∞ÉËØïÊ£ÄÊµãÔºàTracerPidÂøÖÈ°ª‰∏∫0Ôºâ ----------
            case "/proc/self/status": {
                System.out.println("[IOResolver] ‚úì ËøîÂõûËøõÁ®ãÁä∂ÊÄÅÔºàTracerPid=0ÔºåÊú™Ë¢´Ë∞ÉËØïÔºâ");
                // ÊûÑÂª∫ÂÆåÊï¥ÁöÑ status ÂÜÖÂÆπÔºåÂÖ≥ÈîÆÊòØ TracerPid: 0
                StringBuilder statusContent = new StringBuilder();
                // ‰ΩøÁî®VMÁöÑÂåÖÂêç
                String packageName = vm.getPackageName();
                statusContent.append("Name:\t").append(packageName).append("\n");
                statusContent.append("Umask:\t0077\n");
                statusContent.append("State:\tS (sleeping)\n");
                statusContent.append("Tgid:\t").append(emulator.getPid()).append("\n");
                statusContent.append("Ngid:\t0\n");
                statusContent.append("Pid:\t").append(emulator.getPid()).append("\n");
                statusContent.append("PPid:\t1\n");
                statusContent.append("TracerPid:\t0\n");  // ‚≠ê ÂÖ≥ÈîÆÔºöÂøÖÈ°ª‰∏∫0ÔºåË°®Á§∫Êú™Ë¢´Ë∞ÉËØï
                statusContent.append("Uid:\t10185\t10185\t10185\t10185\n");
                statusContent.append("Gid:\t10185\t10185\t10185\t10185\n");
                
                return FileResult.success(new ByteArrayFileIO(oflags, pathname,
                        statusContent.toString().getBytes(StandardCharsets.UTF_8)));
            }

            // ---------- /proc/self/maps: APKË∑ØÂæÑÊü•ÊâæÂíåÂÆåÊï¥ÊÄßÊ†°È™å ----------
            case "/proc/self/maps": {
                System.out.println("[IOResolver] ‚úì ËøîÂõûÊûÅÁÆÄ mapsÔºà‰ΩøÁî®ÁúüÂÆûÂåÖÂêçÊûÑÈÄ†Ë∑ØÂæÑÔºâ");
                // ‰ΩøÁî®ÁúüÂÆûÂåÖÂêçÊûÑÈÄ†APKË∑ØÂæÑ
                String packageName = vm.getPackageName();
                final String APK_PATH = "/data/app/~~tNMZVmV0fBgOq2lCiMwGRA==/" + packageName + "-JZD_aIoXsKoTPab3p20hBw==/base.apk";
                System.out.println("[IOResolver]   APKË∑ØÂæÑ: " + APK_PATH);
                
                // ÊûÑÈÄ†‰∏Ä‰∏™ËôöÊãüÁöÑÂÜÖÂ≠òÊò†Â∞ÑÊù°ÁõÆ
                // Ê†ºÂºè: Ëµ∑ÂßãÂú∞ÂùÄ-ÁªìÊùüÂú∞ÂùÄ ÊùÉÈôê ÂÅèÁßª ËÆæÂ§á inode Ë∑ØÂæÑ
                StringBuilder mapsContent = new StringBuilder();
                mapsContent.append("7fbe852000-7fbe853000 r-xp 00000000 00:00 0 ").append(APK_PATH).append("\n");
                
                // ÂèØÈÄâÔºöÊ∑ªÂä† SO Â∫ìÁöÑÊò†Â∞ÑÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
                // mapsContent.append("12000000-12072000 r-xp 00000000 103:09 12345 /data/app/.../lib/arm64/libkwsgmain.so\n");
                
                return FileResult.success(new ByteArrayFileIO(oflags, pathname,
                        mapsContent.toString().getBytes(StandardCharsets.UTF_8)));
            }

            // ---------- /dev/__properties__: Á≥ªÁªüÂ±ûÊÄßÂ≠òÂÇ® ----------
            case "/dev/__properties__": {
                System.out.println("[IOResolver] ‚úì ËøîÂõûÁ©∫Â±ûÊÄßÊñá‰ª∂");
                return FileResult.success(new ByteArrayFileIO(oflags, pathname,
                        new byte[0]));  // Á©∫Êñá‰ª∂Âç≥ÂèØ
            }

            // ---------- ÂÖ∂‰ªñÊú™Â§ÑÁêÜÁöÑÊñá‰ª∂ ----------
            default:
                // ËøîÂõû null ËÆ© Unidbg ‰ΩøÁî®ÈªòËÆ§Â§ÑÁêÜ
                // ÂØπ‰∫é /proc/stat Á≠âÊñá‰ª∂ÔºåUnidbg ‰ºöËá™Âä®Â§ÑÁêÜ
                return null;
        }
    }


    /**
     * ‰øÆÂ§çGOTË°® - Â∞ÜGOTË°®È°πÊåáÂêëAndroidModuleÊèê‰æõÁöÑÁúüÂÆûÂáΩÊï∞ÂÆûÁé∞
     * <p>
     * ÈóÆÈ¢òÂàÜÊûêÔºö
     * - libkwsgmain.so ‰∏≠ÊúâÂ§ö‰∏™ AssetManager ÂáΩÊï∞ÁöÑ GOT Ë°®È°πÊú™Ë¢´Ê≠£Á°ÆÈáçÂÆö‰Ωç
     * - ÂΩì PLT ‰ª£Á†Å‰ªéËøô‰∫õ GOT Ë°®È°πÂä†ËΩΩÂú∞ÂùÄÊó∂Ôºå‰ºöË∑≥ËΩ¨Âà∞Êó†ÊïàÂú∞ÂùÄÔºàÂ¶Ç 0x9c00Ôºâ
     * <p>
     * Ëß£ÂÜ≥ÊñπÊ°àÔºö
     * - AndroidModule Â∑≤ÁªèÈÄöËøáËôöÊãüÊ®°ÂùóÊèê‰æõ‰∫ÜÂÆåÊï¥ÁöÑ AssetManager ÂÆûÁé∞
     * - Êàë‰ª¨‰ªé libandroid.so Á¨¶Âè∑Ë°®Ëé∑ÂèñËøô‰∫õÂáΩÊï∞ÁöÑÁúüÂÆûÂú∞ÂùÄ
     * - Â∞Ü GOT Ë°®È°πÈáçÂÆöÂêëÂà∞Ëøô‰∫õÁúüÂÆûÂú∞ÂùÄ
     */
    private void fixGotTable() {
        Backend backend = emulator.getBackend();
        System.out.println("\n[GOT‰øÆÂ§ç] ÂºÄÂßã‰øÆÂ§ç AssetManager GOT Ë°®È°π...");

        // Êü•Êâæ libandroid.so Ê®°Âùó
        com.github.unidbg.Module androidModule = emulator.getMemory().findModule("libandroid.so");
        if (androidModule == null) {
            System.out.println("[GOT‰øÆÂ§ç] ‚ùå Êâæ‰∏çÂà∞ libandroid.soÔºåÊó†Ê≥ï‰øÆÂ§ç");
            return;
        }

        System.out.println("[GOT‰øÆÂ§ç] ‚úì ÊâæÂà∞ libandroid.so at 0x" + Long.toHexString(androidModule.base));

        // ÂÆö‰πâÈúÄË¶Å‰øÆÂ§çÁöÑGOTË°®È°πÂèäÂÖ∂ÂØπÂ∫îÁöÑÂáΩÊï∞Âêç
        // Ê≥®ÊÑèÔºöÊúâ‰∫õÂáΩÊï∞ AndroidModule Ê≤°ÊúâÂÆûÁé∞ÔºåÈúÄË¶ÅÂàõÂª∫ stub
        String[][] gotMappings = {
                {"0x6eaf8", "AAssetManager_open"},
                {"0x6eb50", "AAssetManager_fromJava"},
                {"0x6eb80", "AAsset_close"},
                {"0x6ebe8", "AAssetDir_getNextFileName"},  // ÈúÄË¶Å stub
                {"0x6ec40", "AAsset_read"},
                {"0x6ecf0", "AAssetManager_openDir"},      // ÈúÄË¶Å stub
                {"0x6ee28", "AAsset_getLength"},
                {"0x6ee48", "AAssetDir_close"},            // ÈúÄË¶Å stub
        };

        // ÂàõÂª∫‰∏Ä‰∏™ËøîÂõû NULL ÁöÑ stub Áî®‰∫éÊú™ÂÆûÁé∞ÁöÑÂáΩÊï∞
        // ÂøÖÈ°ª‰ΩøÁî® mmap Âπ∂ËÆæÁΩÆÊâßË°åÊùÉÈôê
        Memory memory = emulator.getMemory();
        long stubAddr = memory.mmap(0x1000, UnicornConst.UC_PROT_READ | UnicornConst.UC_PROT_EXEC).peer;
        byte[] stubCode = {
                (byte) 0x00, (byte) 0x00, (byte) 0x80, (byte) 0xD2,  // MOV X0, #0
                (byte) 0xC0, (byte) 0x03, (byte) 0x5F, (byte) 0xD6   // RET
        };
        backend.mem_write(stubAddr, stubCode);
        System.out.println("[GOT‰øÆÂ§ç] ÂàõÂª∫ÂèØÊâßË°å stub at 0x" + Long.toHexString(stubAddr) + " (ËøîÂõûNULL)");

        int successCount = 0;
        for (String[] mapping : gotMappings) {
            long gotOffset = Long.parseLong(mapping[0].substring(2), 16);
            String funcName = mapping[1];

            long funcAddr;
            // ‰ªé libandroid.so Êü•ÊâæÂáΩÊï∞Âú∞ÂùÄ
            com.github.unidbg.Symbol symbol = androidModule.findSymbolByName(funcName, false);
            if (symbol == null) {
                // ‰ΩøÁî® stub ÂáΩÊï∞
                funcAddr = stubAddr;
                System.out.println("[GOT‰øÆÂ§ç]   ‚ö† " + funcName + " -> 0x" + Long.toHexString(funcAddr) + " (stub)");
            } else {
                funcAddr = symbol.getAddress();
                System.out.println("[GOT‰øÆÂ§ç]   ‚úì " + funcName + " -> 0x" + Long.toHexString(funcAddr));
            }

            // ÂáÜÂ§áÂú∞ÂùÄÁöÑÂ≠óËäÇÊï∞ÁªÑÔºàÂ∞èÁ´ØÂ∫èÔºâ
            byte[] addrBytes = new byte[8];
            for (int i = 0; i < 8; i++) {
                addrBytes[i] = (byte) ((funcAddr >> (i * 8)) & 0xFF);
            }

            // ÂÜôÂÖ•GOTË°®
            long gotAddr = module.base + gotOffset;
            backend.mem_write(gotAddr, addrBytes);
            successCount++;
        }

        System.out.println("[GOT‰øÆÂ§ç] ‚úì ÊàêÂäü‰øÆÂ§ç " + successCount + "/" + gotMappings.length + " ‰∏™GOTË°®È°π\n");
    }

    /**
     * ËÆæÁΩÆÊåá‰ª§Ë∑üË∏™ - Ë∑üË∏™Âä†ÂØÜÂáΩÊï∞Âú®ËØªÂèñÊï∞ÊçÆÂêéÁöÑÊâßË°åÊµÅÁ®ã
     * ÁõÆÊ†áÔºöÊâæÂá∫ËøîÂõû0‰πãÂâçÁöÑÂà§Êñ≠ÈÄªËæë
     */
    private void setupInstructionTrace() {
        Backend backend = emulator.getBackend();

        // ÂÖ≥ÈîÆÂú∞ÂùÄÁÇπÔºö
        // 0x42bc8: GetByteArrayRegion ‰πãÂêéÔºàÊï∞ÊçÆÂ∑≤ËØªÂèñÔºâ
        // 0x41de4: ReleaseStringUTFCharsÔºàÂáΩÊï∞Âç≥Â∞ÜËøîÂõûÔºâ
        long traceStart = module.base + 0x42bc8;  // Êï∞ÊçÆËØªÂèñÂÆåÊàê
        long traceEnd = module.base + 0x43000;    // Ë¶ÜÁõñÂà∞ËøîÂõûÁÇπ

        System.out.println("\n[Êåá‰ª§Ë∑üË∏™] ËÆæÁΩÆË∑üË∏™ËåÉÂõ¥: 0x" + Long.toHexString(traceStart) +
                " - 0x" + Long.toHexString(traceEnd));
        System.out.println("[Êåá‰ª§Ë∑üË∏™] ÈáçÁÇπÂÖ≥Ê≥®ÔºöX1ÂØÑÂ≠òÂô®‰∏∫‰ΩïÂßãÁªà‰∏∫0");

        // Ê∑ªÂä†‰ª£Á†Åhook - Ë∑üË∏™ÊØèÊù°Êåá‰ª§
        backend.hook_add_new(new CodeHook() {
            private int instructionCount = 0;
            private long lastAddress = 0;
            private final int MAX_INSTRUCTIONS = 200;  // ÈôêÂà∂ËæìÂá∫Êï∞Èáè

            @Override
            public void onAttach(UnHook unHook) {
                // Hook attach ÂõûË∞É
            }

            @Override
            public void detach() {
                // Hook detach ÂõûË∞É
            }

            @Override
            public void hook(Backend backend, long address, int size, Object user) {
                instructionCount++;

                // Âè™ÊòæÁ§∫ÂâçNÊù°Êåá‰ª§ÔºåÈÅøÂÖçËæìÂá∫ËøáÂ§ö
                if (instructionCount > MAX_INSTRUCTIONS) {
                    return;
                }

                if (instructionCount == MAX_INSTRUCTIONS) {
                    System.out.println("[Êåá‰ª§Ë∑üË∏™] Â∑≤ËææÂà∞ÊúÄÂ§ßË∑üË∏™Êï∞ÈáèÔºåÂÅúÊ≠¢ËæìÂá∫...");
                    return;
                }

                try {
                    // ËØªÂèñÊåá‰ª§Â≠óËäÇ
                    byte[] code = backend.mem_read(address, size);
                    String hexCode = toHexString(code);

                    // ËØªÂèñÂÖ≥ÈîÆÂØÑÂ≠òÂô®
                    long x0 = backend.reg_read(Arm64Const.UC_ARM64_REG_X0).longValue();
                    long x1 = backend.reg_read(Arm64Const.UC_ARM64_REG_X1).longValue();
                    long lr = backend.reg_read(Arm64Const.UC_ARM64_REG_LR).longValue();

                    // Ê†ºÂºèÂåñËæìÂá∫
                    String offset = String.format("0x%05x", address - module.base);
                    System.out.printf("[Ë∑üË∏™#%03d] %s: %s | X0=0x%x X1=0x%x LR=0x%x\n",
                            instructionCount, offset, hexCode, x0, x1, lr);

                    // Ê£ÄÊµãÂÖ≥ÈîÆÊåá‰ª§Ê®°Âºè
                    detectKeyInstructions(address, code, backend);

                    lastAddress = address;

                } catch (Exception e) {
                    System.out.println("[Êåá‰ª§Ë∑üË∏™] ÈîôËØØ: " + e.getMessage());
                }
            }

            /**
             * Ê£ÄÊµãÂÖ≥ÈîÆÊåá‰ª§Ê®°Âºè
             */
            private void detectKeyInstructions(long address, byte[] code, Backend backend) {
                if (code.length < 4) return;

                // ARM64 Êåá‰ª§ÊòØÂ∞èÁ´ØÂ∫è
                int instruction = ((code[3] & 0xFF) << 24) |
                        ((code[2] & 0xFF) << 16) |
                        ((code[1] & 0xFF) << 8) |
                        (code[0] & 0xFF);

                // Ê£ÄÊµã CMP Êåá‰ª§ÔºàÊØîËæÉÊìç‰ΩúÔºâ
                if ((instruction & 0x7F200000) == 0x6B000000) {
                    int rn = (instruction >> 5) & 0x1F;
                    int rm = (instruction >> 16) & 0x1F;
                    try {
                        long rnVal = backend.reg_read(Arm64Const.UC_ARM64_REG_X0 + rn).longValue();
                        long rmVal = backend.reg_read(Arm64Const.UC_ARM64_REG_X0 + rm).longValue();
                        System.out.println("[üîç CMP] X" + rn + " vs X" + rm +
                                " (0x" + Long.toHexString(rnVal) + " vs 0x" + Long.toHexString(rmVal) + ")");
                        if (rnVal != rmVal) {
                            System.out.println("    [‚ö†Ô∏è] ÊØîËæÉÁªìÊûúÔºö‰∏çÁõ∏Á≠âÔºÅËøôÂ∞ÜËß¶ÂèëÂêéÁª≠ÁöÑÊù°‰ª∂Ë∑≥ËΩ¨");
                        }
                    } catch (Exception e) {
                    }
                }

                // Ê£ÄÊµãÊù°‰ª∂ÂàÜÊîØ (B.cond: 01010100_xxxxxxxx_xxxxxxxx_xxx0xxxx)
                if ((instruction & 0xFF000010) == 0x54000000) {
                    String cond = getConditionCode((instruction >> 0) & 0xF);
                    long target = address + ((instruction >> 5) & 0x7FFFF) * 4;
                    System.out.println("[‚ö† Êù°‰ª∂ÂàÜÊîØ] B." + cond + " -> 0x" + Long.toHexString(target - module.base));

                    // ÁâπÂà´ÂÖ≥Ê≥®Ë∑≥ËΩ¨Âà∞ 0x43368 ÁöÑÊÉÖÂÜµ
                    if ((target - module.base) == 0x43368) {
                        System.out.println("    [üí• Ëá¥ÂëΩË∑≥ËΩ¨] ËøôÊòØÂØºËá¥ËøîÂõû0ÁöÑÈîôËØØË∑ØÂæÑÔºÅ");
                        System.out.println("    [ÂàÜÊûê] Âú®Ê≠§‰πãÂâçÁöÑÊØîËæÉÊìç‰ΩúÂ§±Ë¥•ÔºåÈúÄË¶ÅÊ£ÄÊü•‰πãÂâçÁöÑCMPÊåá‰ª§");
                    }
                }

                // Ê£ÄÊµã CBZ/CBNZ (ÊØîËæÉÂπ∂Ë∑≥ËΩ¨)
                if ((instruction & 0x7F000000) == 0x34000000 ||
                        (instruction & 0x7F000000) == 0x35000000) {
                    boolean isNZ = ((instruction >> 24) & 1) == 1;
                    int reg = instruction & 0x1F;
                    long target = address + (((instruction >> 5) & 0x7FFFF) << 2);
                    System.out.println("[‚ö† Êù°‰ª∂Ë∑≥ËΩ¨] CB" + (isNZ ? "NZ" : "Z") +
                            " X" + reg + " -> 0x" + Long.toHexString(target - module.base));

                    // ËØªÂèñÂØÑÂ≠òÂô®ÂÄº
                    try {
                        long regValue = backend.reg_read(Arm64Const.UC_ARM64_REG_X0 + reg).longValue();
                        System.out.println("    [ÂØÑÂ≠òÂô®] X" + reg + " = 0x" + Long.toHexString(regValue) +
                                " (" + regValue + ")");
                    } catch (Exception e) {
                    }
                }

                // Ê£ÄÊµãÊó†Êù°‰ª∂Ë∑≥ËΩ¨ B (000101xx_xxxxxxxx_xxxxxxxx_xxxxxxxx)
                if ((instruction & 0xFC000000) == 0x14000000) {
                    long offset = ((instruction & 0x03FFFFFF) << 2);
                    if ((offset & 0x08000000) != 0) {  // Á¨¶Âè∑Êâ©Â±ï
                        offset |= 0xFFFFFFF0_00000000L;
                    }
                    long target = address + offset;
                    System.out.println("[‚Üí Êó†Êù°‰ª∂Ë∑≥ËΩ¨] B -> 0x" + Long.toHexString(target - module.base));
                }

                // Ê£ÄÊµã RET ËøîÂõûÊåá‰ª§
                if (instruction == 0xD65F03C0) {
                    long lr = backend.reg_read(Arm64Const.UC_ARM64_REG_LR).longValue();
                    System.out.println("[‚Üê ËøîÂõû] RET (ËøîÂõûÂà∞ 0x" + Long.toHexString(lr) + ")");
                }
            }

            /**
             * Ëé∑ÂèñÊù°‰ª∂Á†ÅÂêçÁß∞
             */
            private String getConditionCode(int cond) {
                String[] codes = {"EQ", "NE", "CS", "CC", "MI", "PL", "VS", "VC",
                        "HI", "LS", "GE", "LT", "GT", "LE", "AL", "NV"};
                return cond < codes.length ? codes[cond] : "??";
            }

        }, traceStart, traceEnd, null);

        System.out.println("[Êåá‰ª§Ë∑üË∏™] ‚úì Ë∑üË∏™Â∑≤ËÆæÁΩÆ\n");
    }

    /**
     * Â≠óËäÇÊï∞ÁªÑËΩ¨ÂçÅÂÖ≠ËøõÂà∂Â≠óÁ¨¶‰∏≤ÔºàÁî®‰∫éÊåá‰ª§ÊòæÁ§∫Ôºâ
     */
    private static String toHexString(byte[] bytes) {
        if (bytes == null || bytes.length == 0) return "";
        StringBuilder sb = new StringBuilder();
        for (byte b : bytes) {
            sb.append(String.format("%02x", b & 0xFF));
        }
        return sb.toString();
    }

    /**
     * ‰ªéAPKÊñá‰ª∂Ëé∑ÂèñÁúüÂÆûÁöÑÂåÖÂêç
     */
    private String getRealPackageName(File apkFile) {
        try {
            net.dongliu.apk.parser.ApkFile apk = new net.dongliu.apk.parser.ApkFile(apkFile);
            String packageName = apk.getApkMeta().getPackageName();
            apk.close();
            System.out.println("[APKËØäÊñ≠] ‰ªéAPKËØªÂèñÂà∞ÁöÑÂåÖÂêç: " + packageName);
            return packageName;
        } catch (Exception e) {
            System.out.println("[APKËØäÊñ≠] ‚ùå Êó†Ê≥ïËØªÂèñAPKÂåÖÂêç: " + e.getMessage());
            e.printStackTrace();
            return "com.kuaishou.nebula"; // ÈôçÁ∫ßÂà∞ÈªòËÆ§ÂÄº
        }
    }

}