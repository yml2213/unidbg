# âš ï¸ æ–°å‘ç°çš„é—®é¢˜ - Opcodeæ£€æŸ¥å¤±è´¥

## ğŸ“Š é—®é¢˜æè¿°

è™½ç„¶åè°ƒè¯•å˜é‡å·²ç»ä¿®å¤ä¸º0(ä¸çœŸæœºä¸€è‡´),ä½†ä»ç„¶å¤±è´¥:

```
[âš ï¸ Opcodeæ£€æŸ¥] 0x42e08: opcode=0x0, (opcode|8)=0x8
  âŒ æ£€æŸ¥å¤±è´¥! æœŸæœ›0x28AE, å®é™…0x8
```

## ğŸ” é—®é¢˜åˆ†æ

### å…³é”®æ±‡ç¼–æŒ‡ä»¤

```assembly
0x042df4: orr w11, w11, #8      w11=0x28a0 => w11=0x28a8
0x042df8: cmp w11, w12           w11=0x28a8 w12=0x28ae
0x042dfc: ldr w11, [sp, #0x30]   => w11=0xffffffff  âš ï¸ ä»æ ˆè¯»å–é”™è¯¯å€¼!
0x042e04: str w11, [x24, #0xc]   å†™å…¥0xffffffff
0x042e08: b.ne #0x12043368       è·³è½¬åˆ°é”™è¯¯è·¯å¾„
```

### é—®é¢˜æ ¹æº

1. åœ¨ **0x042dfc** å¤„,ä»æ ˆåç§»`[sp+0x30]`è¯»å–çš„å€¼æ˜¯ `0xffffffff`
2. è¿™ä¸ªå€¼ä¸æ˜¯æˆ‘ä»¬ä¼ å…¥çš„opcode (0x28a0)
3. è¿™ä¸ªå€¼å¯èƒ½æ¥è‡ª**æŸä¸ªå‚æ•°**æˆ–**æœªåˆå§‹åŒ–çš„æ ˆç©ºé—´**

### å¯¹æ¯”çœŸæœº

çœŸæœºæ•°æ®æ˜¾ç¤ºç­¾åéªŒè¯æœ‰ä¸¤ä¸ªé”™è¯¯:
```
[ç­¾åç»•è¿‡]   é”™è¯¯ç : 0x111b7 (APKç­¾åéªŒè¯å¤±è´¥ - ZIPè¯»å–/è§£æé”™è¯¯)
[ç­¾åç»•è¿‡]   é”™è¯¯ç : 0x111bc (è¯ä¹¦é“¾éªŒè¯å¤±è´¥)
```

è™½ç„¶æˆ‘ä»¬æ‹¦æˆªäº†é”™è¯¯æŠ¥å‘Š,ä½†**å†…éƒ¨çŠ¶æ€å¯èƒ½å·²ç»è¢«ç ´å**!

## ğŸ¯ å¯èƒ½çš„åŸå› 

### åŸå› 1: ç­¾åéªŒè¯å¤±è´¥å¯¼è‡´å†…éƒ¨çŠ¶æ€æŸå

è™½ç„¶æˆ‘ä»¬Hookäº† `sub_3E5C0` ç›´æ¥è¿”å›æˆåŠŸ,ä½†:
- SOå†…éƒ¨å¯èƒ½åœ¨å…¶ä»–åœ°æ–¹æ£€æŸ¥äº†APK
- ZIPè§£æå¤±è´¥å¯èƒ½å¯¼è‡´æŸäº›å†…éƒ¨ç»“æ„æœªæ­£ç¡®åˆå§‹åŒ–
- è¿™äº›æŸåçš„çŠ¶æ€å½±å“äº†åç»­çš„opcodeæ£€æŸ¥

### åŸå› 2: APKè·¯å¾„é—®é¢˜

unidbgè¿”å›çš„APKè·¯å¾„:
```
/data/app/~~En8y40Eyt_9SQIpY8tusUw==/com.kuaishou.nebula-94eN8Qsx7c5Ex2tlhTevMQ==/base.apk
```

è¿™æ˜¯æˆ‘ä»¬åœ¨JNIæ–¹æ³•ä¸­ç¡¬ç¼–ç çš„è·¯å¾„,å¯èƒ½ä¸çœŸå®æƒ…å†µä¸åŒ¹é…ã€‚

### åŸå› 3: å‚æ•°ä¼ é€’é—®é¢˜

æ£€æŸ¥æ‰§è¡Œtrace,å¯èƒ½æŸä¸ªå‚æ•°æ²¡æœ‰æ­£ç¡®ä¼ é€’åˆ°nativeå±‚ã€‚

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆA: ä½¿ç”¨çœŸå®çš„APKç­¾åéªŒè¯ (æ¨è)

ä¸è¦Hookç»•è¿‡ç­¾åéªŒè¯,è€Œæ˜¯**è®©éªŒè¯çœŸæ­£é€šè¿‡**:

1. ç¡®ä¿APKæ–‡ä»¶å¯ä»¥æ­£ç¡®æ‰“å¼€å’Œè¯»å–
2. ç¡®ä¿ç­¾åä¿¡æ¯æ­£ç¡®è¿”å›
3. ç¡®ä¿åŒ…å/ç­¾ååœ¨ç™½åå•ä¸­

### æ–¹æ¡ˆB: æ›´æ·±å±‚çš„Hook

å¦‚æœå¿…é¡»ç»•è¿‡ç­¾åéªŒè¯,éœ€è¦:

1. Hookæ›´æ—©çš„é˜¶æ®µ,åœ¨ZIPè§£æä¹‹å‰
2. æˆ–è€…Hookæ‰€æœ‰ä½¿ç”¨ç­¾åéªŒè¯ç»“æœçš„åœ°æ–¹
3. ç¡®ä¿å†…éƒ¨çŠ¶æ€è¢«æ­£ç¡®è®¾ç½®

### æ–¹æ¡ˆC: ä¿®å¤APKè®¿é—®

æ£€æŸ¥ä¸ºä»€ä¹ˆä¼šæœ‰è¿™äº›é”™è¯¯:
```
é”™è¯¯ç : 0x111b7 - APKç­¾åéªŒè¯å¤±è´¥ - ZIPè¯»å–/è§£æé”™è¯¯
é”™è¯¯ç : 0x111bc - è¯ä¹¦é“¾éªŒè¯å¤±è´¥
```

å¯èƒ½çš„åŸå› :
- APKæ–‡ä»¶è·¯å¾„ä¸å¯¹
- APKæ–‡ä»¶æ— æ³•æ‰“å¼€
- APKç­¾åæ ¼å¼ä¸å¯¹

## ğŸ“ ä¸‹ä¸€æ­¥è°ƒè¯•

### 1. æ£€æŸ¥APKæ–‡ä»¶è®¿é—®

åœ¨ `callObjectMethodV` ä¸­,å½“è°ƒç”¨ `getPackageCodePath` æ—¶,æ‰“å°æ›´å¤šä¿¡æ¯:

```java
case "com/yxcorp/gifshow/App->getPackageCodePath()Ljava/lang/String;": {
    String path = "/data/app/.../base.apk";

    // âš ï¸ æ£€æŸ¥çœŸå®APKæ˜¯å¦å­˜åœ¨
    File realApk = new File("unidbg-android/apks/ksjsb/ksjsb_13.8.40.10657.apk");
    System.out.println("[APKæ£€æŸ¥] çœŸå®APKå­˜åœ¨: " + realApk.exists());
    System.out.println("[APKæ£€æŸ¥] çœŸå®APKå¤§å°: " + realApk.length());

    return new StringObject(vm, path);
}
```

### 2. ä¸æ‹¦æˆªç­¾åé”™è¯¯,è®©å®ƒå¤±è´¥

ä¸´æ—¶æ³¨é‡Šæ‰ç­¾åç»•è¿‡çš„é”™è¯¯æ‹¦æˆª,çœ‹å®Œæ•´çš„é”™è¯¯ä¿¡æ¯:

```java
// case 0x111b7:
// case 0x111bc:
//     return;  // ä¸è¦æ‹¦æˆª,è®©é”™è¯¯æ˜¾ç¤º
```

### 3. æ£€æŸ¥çœŸæœºçš„APKç­¾å

ä½¿ç”¨çœŸæœºhookæ•°æ®ä¸­çš„ç­¾åä¿¡æ¯:
```bash
# ä»APKæå–ç­¾å
keytool -printcert -jarfile ksjsb_13.8.40.10657.apk
```

ç„¶ååœ¨unidbgä¸­æ­£ç¡®è®¾ç½®ç­¾åã€‚

## ğŸ’¡ ä¸´æ—¶ç»•è¿‡æ–¹æ¡ˆ

å¦‚æœä»¥ä¸Šéƒ½ä¸è¡Œ,å¯ä»¥å°è¯•:

### ä¿®æ”¹Opcodeæ£€æŸ¥çš„Hook

åœ¨ `ExecutionTracer.java` ä¸­,å½“æ£€æµ‹åˆ°opcodeæ£€æŸ¥å¤±è´¥æ—¶,**å¼ºåˆ¶ä¿®æ”¹å¯„å­˜å™¨**:

```java
// åœ¨0x42e08å¤„
if (address == module.base + 0x42e08) {
    // è¯»å–å½“å‰opcode
    long w11 = backend.reg_read(Arm64Const.UC_ARM64_REG_X11).longValue() & 0xFFFFFFFF;

    if (w11 != 0x28A8) {
        System.out.println("[ä¸´æ—¶ä¿®å¤] å¼ºåˆ¶è®¾ç½®opcodeä¸º0x28A8");
        backend.reg_write(Arm64Const.UC_ARM64_REG_X11, 0x28A8);
    }
}
```

ä½†è¿™åªæ˜¯**æ©ç›–ç—‡çŠ¶**,ä¸æ˜¯çœŸæ­£çš„è§£å†³æ–¹æ¡ˆ!

## ğŸ¯ æ¨èè¡ŒåŠ¨

1. **ä¼˜å…ˆ**: æ£€æŸ¥ä¸ºä»€ä¹ˆAPKç­¾åéªŒè¯å¤±è´¥ (0x111b7, 0x111bc)
2. **ç„¶å**: ä¿®å¤APKè®¿é—®æˆ–ç­¾åé—®é¢˜
3. **æœ€å**: é‡æ–°æµ‹è¯•,åº”è¯¥å°±èƒ½é€šè¿‡äº†

å…³é”®æ˜¯è¦**è®©ç­¾åéªŒè¯çœŸæ­£é€šè¿‡**,è€Œä¸æ˜¯ç®€å•åœ°Hookç»•è¿‡!
